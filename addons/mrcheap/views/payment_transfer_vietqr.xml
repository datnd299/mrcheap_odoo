<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Kế thừa trực tiếp template gốc -->
    <template id="custom_state_header1"
              inherit_id="payment.state_header"
              name="Core Payment Form - VietQR (transfer only)"
              priority="50">
        <!-- Chèn SAU block options để luôn bắt được -->
        <xpath expr="//div[@id='o_payment_status_message']" position="replace">
            <script type="text/javascript" src="/mrcheap/static/src/js/payment_poll.js"></script>
            <div t-if="tx.provider_id.sudo().code == 'custom'"
                 id="o_payment_status_message"
                 class="order-3 order-md-1 flex-grow-1"
            >
                <div class="card flex-grow-1">
                    <div id="o_payment_status_message_details" class="card-body">
                        <div class="mt-4 px-2">
                            <p>
                                Số tiền:
                                <span t-esc="tx.amount"
                                      t-options="{'widget': 'monetary', 'display_currency': tx.currency_id}"/>
                                <t t-if="object">— Tham chiếu:
                                    <t t-esc="object.name"/>
                                </t>
                                <t t-else="">— Tham chiếu:
                                    <t t-esc="reference"/>
                                </t>
                            </p>
                            <div>
                                <span>Mã giao dịch: </span>
                                <span t-esc="tx.id"/>
                            </div>
                            <div t-if="tx.state == 'pending' and tx.invoice_ids[0].payment_state != 'paid'" class="mt-3">
                                <div id="mrcheap-payment-poll"
                               t-att-data-tx-id="tx and tx.id" t-att-data-tx-state="tx.state"
                               t-att-data-token="request and request.params.get('access_token') or ''"
                                     t-att-data-invpayment="tx.invoice_ids[0].payment_state"
                               class="d-none"/>
                                <h5>Quét mã QR để chuyển khoản nhanh</h5>
                                <h6>Thông tin chuyển khoản:</h6>
                                <span t-set="bank_content" t-value="'PTRX' + str(tx.id) + 'PTRX'"/>
                                <t t-set="bank_accounts"
                                   t-value="request.env['res.partner.bank'].sudo().search([('partner_id', '=', request.env.company.partner_id.id)])"/>
                                <t t-if="bank_accounts">
                                    <t t-foreach="bank_accounts" t-as="bank_account">
                                        <div class="card mb-2">
                                            <div class="card-body p-3">
                                                <div class="d-flex flex-wrap">
                                                    <img style="width: 300px"
                                                         t-att-src="'https://qr.sepay.vn/img?acc=%s&amp;bank=%s&amp;amount=%s&amp;des=%s' % (
                                            bank_account.acc_number,
                                            bank_account.bank_id.bic,
                                            tx.amount,
                                            bank_content
                                        )"/>
                                                    <div>
                                                        <div>
                                                            <strong>Ngân hàng:</strong>
                                                            <span t-esc="bank_account.bank_id.name"/>
                                                        </div>
                                                        <div>
                                                            <strong>Số tài khoản:</strong>
                                                            <span t-esc="bank_account.acc_number"/>
                                                        </div>
                                                        <div>
                                                            <strong>Số tiền:</strong>
                                                            <span t-esc="tx.amount"
                                                                  t-options="{'widget': 'monetary', 'display_currency': tx.currency_id}"/>
                                                        </div>
                                                        <div>
                                                            <strong>Nội dung:</strong>
                                                            <span t-esc="bank_content"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="alert alert-warning">
                                        Chưa có thông tin tài khoản ngân hàng được cấu hình.
                                    </div>
                                </t>
                            </div>
                            <div t-else="">
                                <div class="alert alert-success mt-4">
                                        Đã thanh toán
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>
    </template>
</odoo>
